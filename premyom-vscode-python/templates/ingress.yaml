{{- /*
Simple Ingress pour exposer le VSCode custom via Traefik.

On se base sur les valeurs d’ingress (hostname, ingressClassName, …)
si elles sont présentes, mais on ne casse pas le rendu si .Values.ingress
est absent ou typé autrement (cas actuel pour premyom-vscode-python).
*/ -}}

{{- $ing := dict }}
{{- if kindIs "map" .Values.ingress }}
{{-   $ing = .Values.ingress }}
{{- end }}

{{- $enabled := false }}
{{- if and $ing (hasKey $ing "enabled") }}
{{-   $enabled = (index $ing "enabled") }}
{{- end }}

{{- if $enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "premyom-vscode-python.fullname" . }}-ui
  labels:
    app: premyom-vscode-python
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.tls.certresolver: le
spec:
  {{- $className := "" }}
  {{- if and $ing (hasKey $ing "ingressClassName") }}
  {{-   $className = (index $ing "ingressClassName") }}
  {{- end }}
  {{- if $className }}
  ingressClassName: {{ $className | quote }}
  {{- end }}
  {{- $hostname := "" }}
  {{- if and $ing (hasKey $ing "hostname") }}
  {{-   $hostname = (index $ing "hostname") }}
  {{- end }}
  tls:
    - hosts:
        - {{ $hostname | quote }}
  rules:
    - host: {{ $hostname | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ include "premyom-vscode-python.fullname" . }}
                port:
                  number: 8080
{{- end }}
