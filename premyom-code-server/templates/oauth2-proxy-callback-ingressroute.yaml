{{- /*
Route dédiée au callback OIDC en mode `embedded`.

Important:
- On ne la déclare PAS en `Ingress` Kubernetes, sinon Onyxia peut ouvrir ce endpoint
  (proxy-prefix) au lieu du vrai workspace => écran "not found".
- On utilise un `IngressRoute` Traefik (CRD) : Onyxia n'en tient pas compte pour "Ouvrir le service",
  mais Traefik route quand même le callback Keycloak.

Pourquoi un host unique ?
- Keycloak legacy ne supporte pas les wildcards sur le hostname (`https://*.domain/...`).
- On utilise donc un host unique (ex: datalab.arkam-group.com) et un path par release:
    /premyom-oauth2/<release>/callback
- Côté Keycloak, il suffit d'autoriser:
    https://datalab.arkam-group.com/premyom-oauth2/*
*/ -}}
{{- if and .Values.sso.ingress.enabled (eq (default "forwardAuth" .Values.sso.mode) "embedded") -}}
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ include "premyom-code-server.fullname" . }}-oauth2-callback
  labels:
    {{- include "premyom-code-server.labels" . | nindent 4 }}
spec:
  entryPoints:
    - {{ ternary "websecure" "web" (default false .Values.sso.ingress.tls) }}
  routes:
    - match: {{ printf "Host(`%s`) && PathPrefix(`/premyom-oauth2/%s`)" (include "premyom-code-server.centralHost" .) .Release.Name | quote }}
      kind: Rule
      services:
        - name: {{ include "premyom-code-server.fullname" . }}-oauth2-proxy
          port: 8080
  {{- if .Values.sso.ingress.tls }}
  tls:
    certResolver: le
  {{- end }}
{{- end }}
