{
  "$schema": "http://json-schema.org/draft-07/schema",
  "type": "object",
  "properties": {
    "sso": {
  "title": "SSO",
  "type": "object",
  "properties": {
    "mode": {
      "title": "Mode",
      "type": "string",
      "default": "embedded",
      "enum": ["forwardAuth", "embedded"],
      "description": "forwardAuth: s'appuie sur le oauth2-proxy central via middleware Traefik. embedded: déploie un oauth2-proxy par workspace.",
      "x-onyxia": {
        "hidden": true
      }
    },
    "forwardAuth": {
      "title": "ForwardAuth (Traefik)",
      "type": "object",
      "properties": {
        "middleware": {
          "title": "Middleware",
          "type": "string",
          "default": "onyxia-workspace-sso-chain@kubernetescrd",
          "description": "Référence du middleware Traefik à appliquer (ex: onyxia-workspace-sso-chain@kubernetescrd).",
          "x-onyxia": {
            "hidden": true
          }
        }
      }
    },
    "secretName": {
      "title": "Secret (client/cookie)",
      "type": "string",
      "default": "oauth2-proxy",
      "description": "Secret dans le namespace du workspace (keys: client-id, client-secret, cookie-secret)."
        },
        "issuerUrl": {
          "title": "OIDC issuer URL",
          "type": "string",
          "default": "https://auth.datalab.arkam-group.com/auth/realms/onyxia"
        },
        "redirectUrl": {
          "title": "Redirect URL (callback)",
          "type": "string",
          "default": "",
          "description": "Laisser vide: le chart calcule automatiquement le callback à partir du hostname du workspace (ex: https://<workspace-host>/oauth2/callback).",
          "x-onyxia": { "hidden": true }
        },
        "cookieDomain": {
          "title": "Cookie domain",
          "type": "string",
          "default": ".datalab.arkam-group.com"
        },
        "whitelistDomain": {
          "title": "Allowed redirect domains",
          "type": "string",
          "default": ".datalab.arkam-group.com"
        },
        "ingress": {
          "title": "Ingress (SSO)",
          "type": "object",
          "form": true,
          "x-onyxia": {
            "overwriteSchemaWith": "ide/ingress.json"
          },
          "properties": {
            "enabled": {
              "description": "Enable Ingress",
              "type": "boolean",
              "default": true,
              "x-onyxia": {
                "hidden": true,
                "overwriteDefaultWith": "k8s.ingress"
              }
            },
            "hostname": {
              "type": "string",
              "form": true,
              "title": "Hostname",
              "x-onyxia": {
                "hidden": true,
                "overwriteDefaultWith": "{{project.id}}-{{k8s.randomSubdomain}}-0.{{k8s.domain}}"
              }
            },
            "ingressClassName": {
              "type": "string",
              "form": true,
              "title": "ingressClassName",
              "default": "",
              "x-onyxia": {
                "hidden": true,
                "overwriteDefaultWith": "{{k8s.ingressClassName}}"
              }
            }
          }
        }
      }
    },
    "vscode-python": {
      "title": "Code-server (embedded)",
      "type": "object",
      "properties": {
        "premyom": {
          "title": "Premyom (montages S3)",
          "type": "object",
          "properties": {
            "userGroupsJson": {
              "title": "User groups (JSON)",
              "type": "array",
              "default": [],
              "x-onyxia": {
                "hidden": true,
                "overwriteDefaultWith": "{{user.decodedIdToken.groups}}"
              }
            },
            "s3Mount": {
              "title": "S3 mounts",
              "type": "object",
              "properties": {
                "enabled": {
                  "title": "Enable mounts",
                  "type": "string",
                  "default": "true",
                  "x-onyxia": { "hidden": true }
                },
                "nonHdsEndpointHost": {
                  "title": "Non-HDS endpoint host",
                  "type": "string",
                  "default": "cellar-c2.services.clever-cloud.com"
                },
                "hdsEndpointHost": {
                  "title": "HDS endpoint host",
                  "type": "string",
                  "default": "cellar-c2.services.clever-cloud.com"
                },
                "vaultNonHdsPath": {
                  "title": "Vault path non-HDS",
                  "type": "string",
                  "default": "secret/data/premyom/s3/nonhds"
                },
                "vaultHdsPath": {
                  "title": "Vault path HDS",
                  "type": "string",
                  "default": "secret/data/premyom/s3/hds"
                },
                "mountRoot": {
                  "title": "Mount root",
                  "type": "string",
                  "default": "/mnt/s3"
                }
              }
            }
          }
        },
        "service": {
          "title": "Service",
          "type": "object",
          "properties": {
            "image": {
              "title": "Docker image",
              "type": "object",
              "properties": {
                "pullPolicy": {
                  "title": "Pull image from registry",
                  "type": "string",
                  "default": "IfNotPresent",
                  "enum": ["IfNotPresent", "Always", "Never"]
                },
                "custom": {
                  "title": "Custom image (imposée)",
                  "type": "object",
                  "properties": {
                    "enabled": {
                      "title": "Use a custom image instead",
                      "type": "boolean",
                      "default": true,
                      "x-onyxia": {
                        "hidden": true,
                        "readonly": true
                      }
                    },
                    "version": {
                      "title": "Name of the custom image",
                      "type": "string",
                      "default": "harbor.lan/premyom/onyxia-code-server:0.1.9",
                      "x-onyxia": {
                        "hidden": true,
                        "readonly": true
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "premyomS3fs": {
          "title": "S3FS (FUSE)",
          "type": "object",
          "x-onyxia": { "hidden": true },
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true
            }
          }
        },
        "resources": {
          "title": "Resources (CPU/RAM)",
          "type": "object",
          "properties": {
            "requests": {
              "type": "object",
              "properties": {
                "cpu": { "type": "string" },
                "memory": { "type": "string" }
              }
            },
            "limits": {
              "type": "object",
              "properties": {
                "cpu": { "type": "string" },
                "memory": { "type": "string" }
              }
            }
          }
        },
        "persistence": {
          "title": "Persistence",
          "type": "object",
          "properties": {
            "size": {
              "title": "Disk size",
              "type": "string",
              "default": "2Gi"
            }
          }
        },
        "security": {
          "title": "Security",
          "type": "object",
          "properties": {
            "password": {
              "title": "Service password",
              "type": "string",
              "default": "unused",
              "x-onyxia": { "hidden": true }
            }
          }
        },
        "ingress": {
          "title": "Ingress (désactivé)",
          "type": "object",
          "x-onyxia": { "hidden": true },
          "properties": {}
        },
        "vault": {
          "title": "Vault (injecté)",
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false,
              "x-onyxia": { "hidden": true }
            },
            "url": {
              "type": "string",
              "default": "",
              "x-onyxia": { "hidden": true, "overwriteDefaultWith": "{{vault.VAULT_ADDR}}" }
            },
            "token": {
              "type": "string",
              "default": "",
              "x-onyxia": { "hidden": true, "overwriteDefaultWith": "{{vault.VAULT_TOKEN}}" }
            },
            "mount": { "type": "string", "default": "", "x-onyxia": { "hidden": true } },
            "secret": { "type": "string", "default": "", "x-onyxia": { "hidden": true } },
            "directory": { "type": "string", "default": "", "x-onyxia": { "hidden": true } },
            "secretName": { "type": "string", "default": "", "x-onyxia": { "hidden": true } }
          }
        }
      }
    }
  }
}
